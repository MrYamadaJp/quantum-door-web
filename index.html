<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quantum Door</title>

  <style>
    :root{
      --bg:#0b0b10;
      --panel:#12121a;
      --line:#2b2b3a;
      --text:#eee;
      --muted:#9aa;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui, -apple-system, Segoe UI, sans-serif;
      background:var(--bg); color:var(--text);
      margin:0; min-height:100vh;
      display:grid; place-items:center;
    }
    .wrap{width:min(860px, 94vw); display:grid; gap:16px;}
    h1{margin:0; font-size:22px;}
    .sub{color:var(--muted); font-size:13px; margin-top:-8px;}
    .hidden{display:none;}

    .stage{
      position:relative;
      height:min(520px, 62vh);
      border:1px solid var(--line);
      border-radius:22px;
      background:radial-gradient(1200px 600px at 50% 30%, #171726, #0b0b10);
      display:grid; place-items:center;
    }
    .hint{
      position:absolute; top:14px; left:14px;
      padding:6px 10px; font-size:12px;
      color:var(--muted); border:1px solid var(--line);
      border-radius:999px;
      background:rgba(18,18,26,.6);
    }

    .doorBtn{
      border:0; background:none; cursor:pointer;
      width:min(330px,70vw); height:min(420px,52vh);
      position:relative;
    }
    .frame{
      position:absolute; inset:0;
      border-radius:22px;
      border:2px solid #3a3a52;
    }
    .inside{
      position:absolute; inset:18px;
      border-radius:16px;
      background:#000; opacity:0;
      transition:opacity .2s;
    }
    .door{
      position:absolute; inset:18px;
      border-radius:16px;
      background:#1b1b28;
      transform-origin:left center;
      transition:transform .5s;
    }
    .doorBtn.opened .door{transform:perspective(900px) rotateY(-70deg);}
    .doorBtn.opened .inside{opacity:1;}
    .doorBtn.opened{pointer-events:none;}

    .result,.addPanel{
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--panel);
      padding:14px 16px;
    }
    #out{font-size:20px;}
    #meta{font-size:12px;color:var(--muted);}
    .addPanel{display:none;gap:10px;}
    .addPanel.show{display:grid;}

    input,button{
      padding:12px;border-radius:14px;
      border:1px solid var(--line);
      background:#0f0f16;color:var(--text);
    }
    button{cursor:pointer;}
  </style>
</head>

<body>
<div class="wrap">
  <h1>ğŸšª é‡å­çš„ãƒ‰ã‚¢</h1>
  <div class="sub">ã‚¯ãƒªãƒƒã‚¯ï¼è¦³æ¸¬ã€‚è¦³æ¸¬ã™ã‚‹ã¾ã§ã€ä¸–ç•Œã¯ç¢ºå®šã—ãªã„ã€‚</div>

  <div class="stage">
    <div class="hint" id="hint">ãƒ‰ã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¦³æ¸¬</div>
    <button id="doorBtn" class="doorBtn">
      <div class="frame"></div>
      <div class="inside"></div>
      <div class="door"></div>
    </button>
  </div>

  <div class="result hidden" id="resultBox">
    <b>è¦³æ¸¬çµæœ</b>
    <div id="out"></div>
    <small id="meta"></small>
  </div>

  <div class="addPanel" id="addPanel">
    <b>è¦³æ¸¬çµæœã‚’è¿½åŠ ï¼ˆå…±æœ‰ï¼‰</b>
    <input id="inp" maxlength="60" placeholder="ä¾‹ï¼šé™å¯‚ / ä¸–ç•Œç·šãŒç¢ºå®šã—ãŸ" />
    <button id="add">è¿½åŠ </button>
  </div>
</div>

<script>
/* ===== Worker API ===== */
const API_BASE = "https://quantum-door-api.hinomaru705.workers.dev";

/* ===== åŸºæœ¬å€™è£œ ===== */
const base = [
  "é™å¯‚"
];

/* ===== localStorage keys ===== */
const OBS_KEY_DAY = "quantumDoor.observedDayJST.v1";
const OBS_KEY_RESULT = "quantumDoor.observedResult.v1";
const ADD_KEY_DAY = "quantumDoor.addedDayJST.v1";
const USER_KEY = "quantumDoor.userOutcomes.v1";

/* ===== util ===== */
const loadUser = () => JSON.parse(localStorage.getItem(USER_KEY) || "[]");
const saveUser = a => localStorage.setItem(USER_KEY, JSON.stringify(a));
const pick = a => a[Math.floor(Math.random()*a.length)];
const todayJST = () =>
  new Date(Date.now() + 9*60*60*1000).toISOString().slice(0,10);

/* ===== API ===== */
async function fetchShared(){
  const r = await fetch(`${API_BASE}/pool?limit=200`);
  const j = await r.json().catch(()=>null);
  return (r.ok && j?.ok && Array.isArray(j.outcomes)) ? j.outcomes : [];
}
async function submitShared(text){
  const r = await fetch(`${API_BASE}/submit`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ text })
  });
  const j = await r.json().catch(()=>null);
  return !!(r.ok && j?.ok);
}

/* ===== UI ===== */
const door = document.getElementById("doorBtn");
const out = document.getElementById("out");
const meta = document.getElementById("meta");
const hint = document.getElementById("hint");
const addPanel = document.getElementById("addPanel");
const resultBox = document.getElementById("resultBox");
const inp = document.getElementById("inp");

function showObserved(resultText, metaText){
  door.classList.add("opened");
  door.setAttribute("aria-disabled","true");
  resultBox.classList.remove("hidden");
  addPanel.classList.add("show");
  out.textContent = resultText;
  meta.textContent = metaText || "";
  hint.textContent = "è¦³æ¸¬ã¯å®Œäº†ã—ã¾ã—ãŸ";
}

/* ===== åˆæœŸè¡¨ç¤ºï¼ˆå†è¨ªæ™‚ï¼‰ ===== */
(function init(){
  const today = todayJST();
  const day = localStorage.getItem(OBS_KEY_DAY);
  const res = localStorage.getItem(OBS_KEY_RESULT);
  const added = localStorage.getItem(ADD_KEY_DAY);

  if(day === today && res){
    showObserved(res, "ï¼ˆã“ã®ç«¯æœ«ã¯ä»Šæ—¥ã™ã§ã«è¦³æ¸¬æ¸ˆã¿ï¼‰");
    if(added === today){
      addPanel.classList.remove("show");
    }
  }
})();

/* ===== è¦³æ¸¬ ===== */
door.onclick = async () => {
  const today = todayJST();
  const day = localStorage.getItem(OBS_KEY_DAY);
  const res = localStorage.getItem(OBS_KEY_RESULT);

  if(day === today && res){
    showObserved(res, "ï¼ˆã“ã®ç«¯æœ«ã¯ä»Šæ—¥ã™ã§ã«è¦³æ¸¬æ¸ˆã¿ï¼‰");
    return;
  }

  const shared = await fetchShared();
  const user = loadUser();
  const list = [...new Set([...base, ...user, ...shared].map(s => s.trim()))];
  const r = pick(list);

  localStorage.setItem(OBS_KEY_DAY, today);
  localStorage.setItem(OBS_KEY_RESULT, r);

  showObserved(r, `å€™è£œæ•° ${list.length}`);
};

/* ===== è¿½åŠ ï¼ˆ1æ—¥1å›ï¼‰ ===== */
document.getElementById("add").onclick = async () => {
  const v = inp.value.trim();
  if(!v) return;

  const u = loadUser(); u.push(v); saveUser(u);
  const ok = await submitShared(v);

  out.textContent = ok
    ? `å…±æœ‰ã«è¿½åŠ ã—ã¾ã—ãŸï¼š${v}`
    : `è¿½åŠ ã—ã¾ã—ãŸï¼ˆå…±æœ‰ã¯å¤±æ•—ï¼‰ï¼š${v}`;

  localStorage.setItem(ADD_KEY_DAY, todayJST());
  addPanel.classList.remove("show");
};
</script>
</body>
</html>
