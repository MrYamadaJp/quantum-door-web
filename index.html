<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quantum Door</title>

  <!-- Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <style>
    :root{
      --bg:#0b0b10;
      --panel:#12121a;
      --line:#2b2b3a;
      --text:#eee;
      --muted:#9aa;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:var(--bg); color:var(--text);
      margin:0; min-height:100vh;
      display:grid; place-items:center;
    }
    .wrap{width:min(860px,94vw);display:grid;gap:16px;}
    h1{margin:0;font-size:22px;font-weight:700;}
    .sub{color:var(--muted);font-size:13px;margin-top:-8px;}
    .hidden{display:none;}

    .stage{
      position:relative;
      height:min(520px,62vh);
      border:1px solid var(--line);
      border-radius:22px;
      background:radial-gradient(1200px 600px at 50% 30%, #171726, #0b0b10);
      display:grid;place-items:center;
      overflow:hidden;
    }
    .hint{
      position:absolute;top:14px;left:14px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background:rgba(18,18,26,.6);
    }

    .doorBtn{
      border:0;background:transparent;cursor:pointer;
      width:min(330px,70vw);
      height:min(420px,52vh);
      position:relative;
    }
    .frame{
      position:absolute;inset:0;border-radius:22px;
      border:2px solid #3a3a52;
      background:linear-gradient(180deg,#12121c,#0f0f16);
    }
    .inside{
      position:absolute;inset:18px;border-radius:16px;
      background:radial-gradient(700px 420px at 50% 35%, #0b0b10,#000);
      opacity:0;transition:opacity .25s ease;
    }
    .door{
      position:absolute;inset:18px;border-radius:16px;
      transform-origin:left center;
      background:linear-gradient(180deg,#2a2a3a,#181824);
      transition:transform .5s cubic-bezier(.2,.8,.2,1);
    }
    .knob{
      position:absolute;right:22px;top:50%;
      width:18px;height:18px;border-radius:50%;
      background:linear-gradient(#c9b36a,#7a6a32);
      transform:translateY(-50%);
    }
    .doorBtn.opened .door{transform:perspective(900px) rotateY(-68deg);}
    .doorBtn.opened .inside{opacity:1;}
    .doorBtn.opened{pointer-events:none;}

    .result,.addPanel{
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--panel);
      padding:14px 16px;
    }
    .addPanel{display:none;gap:12px;}
    .addPanel.show{display:grid;}
    input{
      width:100%;padding:12px;border-radius:14px;
      border:1px solid var(--line);
      background:#0f0f16;color:var(--text);
    }
    button{
      padding:12px;border-radius:14px;
      background:#1a1a26;color:var(--text);
      border:1px solid var(--line);
      cursor:pointer;
    }
    .tiny{font-size:12px;color:var(--muted);}
  </style>
</head>

<body>
<div class="wrap">
  <h1>ğŸšª Quantum Door</h1>
  <div class="sub">ã‚¯ãƒªãƒƒã‚¯ï¼è¦³æ¸¬ã€‚è¦³æ¸¬ã™ã‚‹ã¾ã§ã€ä¸–ç•Œã¯ç¢ºå®šã—ãªã„ã€‚</div>

  <div class="stage">
    <div class="hint" id="hint">ãƒ‰ã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¦³æ¸¬</div>
    <button id="doorBtn" class="doorBtn">
      <div class="frame"></div>
      <div class="inside"></div>
      <div class="door"><div class="knob"></div></div>
    </button>
  </div>

  <div class="result hidden" id="resultBox">
    <b>è¦³æ¸¬çµæœ</b>
    <div id="out"></div>
  </div>

  <div class="addPanel" id="addPanel">
    <b>è¦³æ¸¬çµæœã‚’è¿½åŠ ï¼ˆå…±æœ‰ï¼‰</b>

    <input id="inp" maxlength="100" placeholder="è¦³æ¸¬çµæœã‚’å…¥åŠ›" />

    <!-- Turnstile -->
    <div class="cf-turnstile"
      data-sitekey="0x4AAAAAACGlYHwu67S0acHg"
      data-theme="dark">
    </div>

    <button id="add">è¿½åŠ </button>
    <div class="tiny">â€» è¿½åŠ ã¯1æ—¥1å›ã€‚è¿½åŠ å¾Œã¯å†è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</div>
  </div>
</div>

<script>
const API_BASE = "https://quantum-door-api.hinomaru705.workers.dev";
const ADDED_KEY = "quantumDoor.added.v1";

const doorBtn = document.getElementById("doorBtn");
const out = document.getElementById("out");
const hint = document.getElementById("hint");
const addPanel = document.getElementById("addPanel");
const resultBox = document.getElementById("resultBox");
const inp = document.getElementById("inp");

let observed = false;

async function observe(){
  if(observed) return;
  observed = true;

  const r = await fetch(API_BASE + "/pool")
    .then(r=>r.json()).then(j=>j.outcomes[0]);

  doorBtn.classList.add("opened");
  hint.textContent = "è¦³æ¸¬ã¯å®Œäº†ã—ã¾ã—ãŸ";

  out.textContent = r;
  resultBox.classList.remove("hidden");

  if(!localStorage.getItem(ADDED_KEY)){
    addPanel.classList.add("show");
  }
}

doorBtn.addEventListener("click", observe);

document.getElementById("add").addEventListener("click", async ()=>{
  const v = inp.value.trim();
  if(!v) return;

  const tokenInput = document.querySelector(
    'input[name="cf-turnstile-response"]'
  );
  const token = tokenInput ? tokenInput.value : "";

  const res = await fetch(API_BASE + "/submit", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ text:v, turnstileToken:token })
  });

  if(res.ok){
    localStorage.setItem(ADDED_KEY,"1");
    addPanel.remove();
    out.textContent = "å…±æœ‰ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚";
  }else{
    out.textContent = "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
  }
});
</script>
</body>
</html>
