<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quantum Door</title>

  <!-- Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <style>
    :root{
      --bg:#0b0b10;
      --panel:#12121a;
      --line:#2b2b3a;
      --text:#eee;
      --muted:#9aa;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:var(--bg); color:var(--text);
      margin:0; min-height:100vh;
      display:grid; place-items:center;
    }
    .wrap{width:min(860px,94vw);display:grid;gap:16px;}
    h1{margin:0;font-size:22px;font-weight:700;}
    .sub{color:var(--muted);font-size:13px;margin-top:-8px;}
    .hidden{display:none;}

    .stage{
      position:relative;
      height:min(520px,62vh);
      border:1px solid var(--line);
      border-radius:22px;
      background:radial-gradient(1200px 600px at 50% 30%, #171726, #0b0b10);
      display:grid;place-items:center;
      overflow:hidden;
    }
    .hint{
      position:absolute;top:14px;left:14px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      background:rgba(18,18,26,.6);
    }

    .doorBtn{
      border:0;background:transparent;cursor:pointer;
      width:min(330px,70vw);
      height:min(420px,52vh);
      position:relative;
    }
    .frame{
      position:absolute;inset:0;border-radius:22px;
      border:2px solid #3a3a52;
      background:linear-gradient(180deg,#12121c,#0f0f16);
    }
    .inside{
      position:absolute;inset:18px;border-radius:16px;
      background:radial-gradient(700px 420px at 50% 35%, #0b0b10,#000);
      opacity:0;transition:opacity .25s ease;
    }
    .door{
      position:absolute;inset:18px;border-radius:16px;
      transform-origin:left center;
      background:linear-gradient(180deg,#2a2a3a,#181824);
      transition:transform .5s cubic-bezier(.2,.8,.2,1);
    }
    .knob{
      position:absolute;right:22px;top:50%;
      width:18px;height:18px;border-radius:50%;
      background:linear-gradient(#c9b36a,#7a6a32);
      transform:translateY(-50%);
    }
    .doorBtn.opened .door{transform:perspective(900px) rotateY(-68deg);}
    .doorBtn.opened .inside{opacity:1;}
    .doorBtn.opened{pointer-events:none;}

    .result,.addPanel{
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--panel);
      padding:14px 16px;
    }
    .addPanel{display:none;gap:12px;}
    .addPanel.show{display:grid;}
    input{
      width:100%;padding:12px;border-radius:14px;
      border:1px solid var(--line);
      background:#0f0f16;color:var(--text);
    }
    button{
      padding:12px;border-radius:14px;
      background:#1a1a26;color:var(--text);
      border:1px solid var(--line);
      cursor:pointer;
    }
    .tiny{font-size:12px;color:var(--muted);line-height:1.4;}
  </style>
</head>

<body>
<div class="wrap">
  <h1>ğŸšª Quantum Door</h1>
  <div class="sub">ã‚¯ãƒªãƒƒã‚¯ï¼è¦³æ¸¬ã€‚è¦³æ¸¬ã™ã‚‹ã¾ã§ã€ä¸–ç•Œã¯ç¢ºå®šã—ãªã„ã€‚</div>

  <div class="stage">
    <div class="hint" id="hint">ãƒ‰ã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¦³æ¸¬</div>
    <button id="doorBtn" class="doorBtn" aria-label="è¦³æ¸¬ã™ã‚‹ãƒ‰ã‚¢">
      <div class="frame"></div>
      <div class="inside"></div>
      <div class="door"><div class="knob"></div></div>
    </button>
  </div>

  <div class="result hidden" id="resultBox">
    <b>è¦³æ¸¬çµæœ</b>
    <div id="out"></div>
    <small class="tiny" id="meta"></small>
  </div>

  <div class="addPanel" id="addPanel">
    <b>è¦³æ¸¬çµæœã‚’è¿½åŠ ï¼ˆå…±æœ‰ï¼‰</b>

    <input id="inp" maxlength="100" placeholder="è¦³æ¸¬çµæœã‚’å…¥åŠ›ï¼ˆ1ã€œ100æ–‡å­—ï¼‰" />

    <!-- Turnstileã¯å¾Œã‹ã‚‰è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§æ‰‹å‹•renderã™ã‚‹ -->
    <div id="tsMount"></div>

    <button id="add">è¿½åŠ </button>
    <div class="tiny">â€» è¿½åŠ ã¯ã€Œã“ã®ç«¯æœ«ã§æ—¥æœ¬æ™‚é–“1æ—¥1å›ã€ã€‚è¿½åŠ å¾Œã¯ç¿Œæ—¥ã¾ã§å†è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</div>
  </div>
</div>

<script>
/* ====== è¨­å®š ====== */
const API_BASE = "https://quantum-door-api.hinomaru705.workers.dev";
const TURNSTILE_SITE_KEY = "0x4AAAAAACGlYHwu67S0acHg";

/* ====== localStorage keys ====== */
const OBS_KEY_DAY = "quantumDoor.observedDayJST.v1";
const OBS_KEY_RESULT = "quantumDoor.observedResult.v1";
const ADD_KEY_DAY = "quantumDoor.addedDayJST.v1";

/* ====== util ====== */
const todayJST = () => new Date(Date.now() + 9*60*60*1000).toISOString().slice(0,10);

/* ====== UI refs ====== */
const doorBtn = document.getElementById("doorBtn");
const out = document.getElementById("out");
const meta = document.getElementById("meta");
const hint = document.getElementById("hint");
const addPanel = document.getElementById("addPanel");
const resultBox = document.getElementById("resultBox");
const inp = document.getElementById("inp");
const tsMount = document.getElementById("tsMount");
const addBtn = document.getElementById("add");

let turnstileWidgetId = null;

/* ====== Turnstileæç”»ï¼ˆå¾Œã‹ã‚‰è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§æ‰‹å‹•ï¼‰ ====== */
function renderTurnstileIfNeeded(){
  // ã™ã§ã«ä»Šæ—¥è¿½åŠ æ¸ˆã¿ãªã‚‰å‡ºã•ãªã„
  if (localStorage.getItem(ADD_KEY_DAY) === todayJST()) return;

  // Turnstileãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã¾ã èª­ã¿è¾¼ã¿ä¸­ãªã‚‰å°‘ã—å¾…ã£ã¦å†è©¦è¡Œ
  if (!window.turnstile) {
    setTimeout(renderTurnstileIfNeeded, 300);
    return;
  }

  // æ—¢ã«æç”»æ¸ˆã¿ãªã‚‰reset
  if (turnstileWidgetId !== null) {
    try { window.turnstile.reset(turnstileWidgetId); } catch {}
    return;
  }

  // åˆå›æç”»
  tsMount.innerHTML = "";
  turnstileWidgetId = window.turnstile.render(tsMount, {
    sitekey: TURNSTILE_SITE_KEY,
    theme: "dark"
  });
}

/* ====== è¦³æ¸¬è¡¨ç¤º ====== */
function showObserved(resultText, metaText){
  doorBtn.classList.add("opened");
  doorBtn.setAttribute("aria-disabled","true");
  resultBox.classList.remove("hidden");
  out.textContent = resultText;
  meta.textContent = metaText || "";
  hint.textContent = "è¦³æ¸¬ã¯å®Œäº†ã—ã¾ã—ãŸ";
}

/* ====== åˆæœŸï¼šä»Šæ—¥ã™ã§ã«è¦³æ¸¬ã—ã¦ã„ãŸã‚‰é–‹ãã£ã±ãªã— ====== */
(function init(){
  const t = todayJST();
  const d = localStorage.getItem(OBS_KEY_DAY);
  const r = localStorage.getItem(OBS_KEY_RESULT);
  const added = localStorage.getItem(ADD_KEY_DAY);

  if (d === t && r) {
    showObserved(r, "ï¼ˆã“ã®ç«¯æœ«ã¯ä»Šæ—¥ã™ã§ã«è¦³æ¸¬æ¸ˆã¿ï¼‰");

    // è¿½åŠ ã¯ã€Œä»Šæ—¥æœªå®Ÿæ–½ã€ãªã‚‰å‡ºã™
    if (added !== t) {
      addPanel.classList.add("show");
      renderTurnstileIfNeeded();
    }
  }
})();

/* ====== è¦³æ¸¬ï¼ˆ/poolã‹ã‚‰å€™è£œã‚’å–ã£ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤ï¼‰ ====== */
async function observe(){
  const t = todayJST();
  const d = localStorage.getItem(OBS_KEY_DAY);
  const r = localStorage.getItem(OBS_KEY_RESULT);

  if (d === t && r) {
    showObserved(r, "ï¼ˆã“ã®ç«¯æœ«ã¯ä»Šæ—¥ã™ã§ã«è¦³æ¸¬æ¸ˆã¿ï¼‰");
    // è¿½åŠ UIã®è¡¨ç¤ºåˆ¤å®š
    if (localStorage.getItem(ADD_KEY_DAY) !== t) {
      addPanel.classList.add("show");
      renderTurnstileIfNeeded();
    }
    return;
  }

  const poolRes = await fetch(`${API_BASE}/pool?limit=200`);
  const poolJson = await poolRes.json();
  const list = Array.isArray(poolJson?.outcomes) ? poolJson.outcomes : [];
  const pick = list.length ? list[Math.floor(Math.random()*list.length)] : "æ²ˆé»™";

  localStorage.setItem(OBS_KEY_DAY, t);
  localStorage.setItem(OBS_KEY_RESULT, pick);

  showObserved(pick, `å€™è£œæ•° ${list.length || 1}`);

  // è¿½åŠ UIï¼ˆä»Šæ—¥æœªè¿½åŠ ãªã‚‰è¡¨ç¤ºï¼‰
  if (localStorage.getItem(ADD_KEY_DAY) !== t) {
    addPanel.classList.add("show");
    renderTurnstileIfNeeded();
  }
}

doorBtn.addEventListener("click", observe);

/* ====== è¿½åŠ ï¼ˆTurnstile tokenã‚’æ·»ä»˜ã—ã¦ /submitï¼‰ ====== */
addBtn.addEventListener("click", async () => {
  const v = inp.value.trim();
  if (!v) return;

  // ä»Šæ—¥è¿½åŠ æ¸ˆã¿ãªã‚‰å³çµ‚äº†ï¼ˆå¿µã®ãŸã‚ï¼‰
  if (localStorage.getItem(ADD_KEY_DAY) === todayJST()) {
    addPanel.classList.remove("show");
    out.textContent = "ï¼ˆä»Šæ—¥ã¯ã™ã§ã«è¿½åŠ æ¸ˆã¿ï¼‰";
    return;
  }

  // Turnstileå¿œç­”å–å¾—
  let token = "";
  try {
    if (window.turnstile && turnstileWidgetId !== null) {
      token = window.turnstile.getResponse(turnstileWidgetId) || "";
    }
  } catch {}

  if (!token) {
    out.textContent = "èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ï¼ˆTurnstileï¼‰ã€‚";
    return;
  }

  const res = await fetch(`${API_BASE}/submit`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ text: v, turnstileToken: token })
  });

  const j = await res.json().catch(()=>null);

  if (res.ok && j?.ok) {
    // ä»Šæ—¥è¿½åŠ æ¸ˆã¿ã‚’è¨˜éŒ² â†’ ç¿Œæ—¥ã¾ã§å‡ºã•ãªã„
    localStorage.setItem(ADD_KEY_DAY, todayJST());

    // UIã‚’æ¶ˆã™ï¼ˆæ›´æ–°ã—ã¦ã‚‚å¾©æ´»ã—ãªã„ï¼‰
    addPanel.classList.remove("show");
    out.textContent = `å…±æœ‰ã«è¿½åŠ ã—ã¾ã—ãŸï¼š${v}`;
  } else {
    out.textContent = j?.error ? `é€ä¿¡ã«å¤±æ•—ï¼š${j.error}` : "é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    // æ¬¡ã®æŒ‘æˆ¦ã®ãŸã‚ã«Turnstileã‚’ãƒªã‚»ãƒƒãƒˆ
    try { window.turnstile.reset(turnstileWidgetId); } catch {}
  }
});
</script>
</body>
</html>
